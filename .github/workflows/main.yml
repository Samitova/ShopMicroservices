name: ProductsManagement

on:
  push:
    branches:
      - master

jobs:
  build:
  
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Log In to Azure
        uses: azure/login@v1          
        with:
          creds: ${{secrets.AZURE_CREDENTIALS}}

      - name: Azure Log In to Azure Container Registry 
        uses: azure/docker-login@v1          
        with:
          login-server: ${{secrets.ARC_LOGIN_SERVER}}
          username: ${{secrets.ARC_USERNAME}}
          password: ${{secrets.ARC_PASSWORD}}  

      - name: "Build and push docker image"
        id: docker_build
        uses: docker/build-push-action@v5
        with:
            push: true            
            tags: ${{secrets.ARC_LOGIN_SERVER}}/products-management-api:${{github.run_number}}
            file: ./ShopMicroservices.ProductsManagement.Api/Dockerfile

      - name: Deploy To Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
            acrName: ${{secrets.ARC_USERNAME}}
            acrUsername: ${{secrets.ARC_USERNAME}}
            acrPassword: ${{secrets.ARC_PASSWORD}}
            containerAppName: products-management
            resourceGroup: microservices-rg
            imageToDeploy: ${{secrets.ARC_LOGIN_SERVER}}/products-management-api:${{github.run_number}}
            environmentVariables: Logging__LogLevel__Microsoft.EntityFrameworkCore=Debug
     